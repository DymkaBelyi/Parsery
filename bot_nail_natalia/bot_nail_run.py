import os
from dotenv import load_dotenv

import asyncio
from aiogram.types import Message, ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove
from aiogram.filters import Command, CommandStart
from aiogram.fsm.context import FSMContext
from aiogram import Bot, Dispatcher, Router, types
from aiogram.fsm.state import State, StatesGroup
import sqlite3
from datetime import datetime, timedelta

from create_bd import create_available_keyboards, add_appointment
from other_function import send_reminders, delete_old_appointments


load_dotenv()
TOKEN = os.getenv("TOKEN_NAIL")

dp = Dispatcher()
bot = Bot(TOKEN)
router = Router()

ADMIN_IDS = [int(admin_id) for admin_id in os.getenv("ADMINS_NAIL", "").split(",")]


class Booking(StatesGroup):
    name = State()
    phone = State()
    date = State()
    time = State()


# –ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞—Ç—ã
class AdminState(StatesGroup):
    waiting_for_date = State()
    name = State()
    phone = State()
    date = State()
    time = State()


@router.message(Command("admin_book"))
async def admin_book(message: Message, state: FSMContext):
    user_id = message.from_user.id
    if user_id in ADMIN_IDS:
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞:")
        await state.set_state(AdminState.name)
    else:
        await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")


@router.message(AdminState.name)
async def admin_get_name(message: Message, state: FSMContext):
    await state.update_data(name=message.text)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞:")
    await state.set_state(AdminState.phone)


@router.message(AdminState.phone)
async def admin_get_phone(message: Message, state: FSMContext):
    await state.update_data(phone=message.text)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:", reply_markup=date_keyboard)
    await state.set_state(AdminState.date)


@router.message(AdminState.date)
async def admin_get_date(message: Message, state: FSMContext):
    selected_date = message.text.strip()

    if selected_date not in available_dates:
        await message.answer("–û—à–∏–±–∫–∞! –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é.")
        return

    await state.update_data(date=selected_date)
    available_times = available_times_for_dates.get(selected_date, [])

    if not available_times:
        await message.answer("–ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É.")
        return

    time_buttons = [[KeyboardButton(text=time)] for time in available_times]
    time_keyboard = ReplyKeyboardMarkup(keyboard=time_buttons, resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:", reply_markup=time_keyboard)
    await state.set_state(AdminState.time)


@router.message(AdminState.time)
async def admin_get_time(message: Message, state: FSMContext):
    user_data = await state.get_data()
    selected_time = message.text.strip()
    selected_date = user_data.get("date")

    try:
        datetime.strptime(selected_time, "%H:%M")
    except ValueError:
        await message.answer("–û—à–∏–±–∫–∞! –í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è.")
        return

    with sqlite3.connect("appointments.db") as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM appointments WHERE date = ? AND time = ?", (selected_date, selected_time))
        existing_appointment = cursor.fetchone()

    if existing_appointment:
        await message.answer("–ò–∑–≤–∏–Ω–∏—Ç–µ, —ç—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.")
    else:
        add_appointment(user_data["name"], user_data["phone"], selected_date, selected_time, user_id=None)  # user_id=None –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
        confirmation_text = (
            f"‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\nüìÖ –î–∞—Ç–∞: {selected_date}\n‚è∞ –í—Ä–µ–º—è: {selected_time}\n"
            f"üë§ –ò–º—è: {user_data['name']}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: {user_data['phone']}\n\n–ñ–¥—ë–º –≤–∞—Å! üöóüíÖ"
        )
        await message.answer(confirmation_text, reply_markup=ReplyKeyboardRemove())
        await state.clear()


# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏
available_dates, available_times_for_dates = create_available_keyboards()
date_keyboard = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text=date)] for date in available_dates], resize_keyboard=True)


@router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–∞ –º–∞–Ω–∏–∫—é—Ä. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:")
    await state.set_state(Booking.name)


@router.message(Booking.name)
async def get_name(message: Message, state: FSMContext):
    await state.update_data(name=message.text)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:")
    await state.set_state(Booking.phone)


@router.message(Booking.phone)
async def get_phone(message: Message, state: FSMContext):
    user_id = message.from_user.id
    await state.update_data(phone=message.text, user_id=user_id)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:", reply_markup=date_keyboard)
    await state.set_state(Booking.date)


@router.message(Booking.date)
async def get_date(message: Message, state: FSMContext):
    selected_date = message.text.strip()

    if selected_date not in available_dates:
        await message.answer("–û—à–∏–±–∫–∞! –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é.")
        return

    await state.update_data(date=selected_date)
    available_times = available_times_for_dates.get(selected_date, [])

    if not available_times:
        await message.answer("–ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É.")
        return

    time_buttons = [[KeyboardButton(text=time)] for time in available_times]
    time_keyboard = ReplyKeyboardMarkup(keyboard=time_buttons, resize_keyboard=True)
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:", reply_markup=time_keyboard)
    await state.set_state(Booking.time)


@router.message(Booking.time)
async def get_time(message: Message, state: FSMContext):
    user_data = await state.get_data()
    selected_time = message.text.strip()
    selected_date = user_data.get("date")
    user_id = user_data.get("user_id")

    try:
        datetime.strptime(selected_time, "%H:%M")
    except ValueError:
        await message.answer("–û—à–∏–±–∫–∞! –í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è.")
        return

    with sqlite3.connect("appointments.db") as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM appointments WHERE date = ? AND time = ?", (selected_date, selected_time))
        existing_appointment = cursor.fetchone()

    if existing_appointment:
        await message.answer("–ò–∑–≤–∏–Ω–∏—Ç–µ, —ç—Ç–æ –≤—Ä–µ–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –≤—Ä–µ–º—è.")
    else:
        add_appointment(user_data["name"], user_data["phone"], selected_date, selected_time, user_id)
        confirmation_text = (
            f"‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!\nüìÖ –î–∞—Ç–∞: {selected_date}\n‚è∞ –í—Ä–µ–º—è: {selected_time}\n"
            f"üë§ –ò–º—è: {user_data['name']}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: {user_data['phone']}\n\n–ñ–¥—ë–º –≤–∞—Å! üöóüíÖ"
        )
        await message.answer(confirmation_text, reply_markup=ReplyKeyboardRemove())
        await state.clear()

conn = sqlite3.connect("appointments.db")
cursor = conn.cursor()


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã "view_appointments"
@router.message(Command("list"))
async def view_appointments(message: Message, state: FSMContext):
    user_id = message.from_user.id
    if user_id in ADMIN_IDS:
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —ç—Ç—É –¥–∞—Ç—É.")
        await state.set_state(AdminState.waiting_for_date)
    else:
        await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–µ–¥—ë–Ω–Ω–æ–π –¥–∞—Ç—ã
@router.message(AdminState.waiting_for_date)
async def handle_admin_date(message: Message, state: FSMContext):
    user_id = message.from_user.id
    date_input = message.text.strip()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–≤–µ–¥—ë–Ω–Ω–∞—è –¥–∞—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã
        datetime.strptime(date_input, "%Y-%m-%d")
    except ValueError:
        await message.answer("–û—à–∏–±–∫–∞! –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD.")
        return

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–ø–∏—Å–∏ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É
    cursor.execute("SELECT id, user_id, name, phone, date, time FROM appointments WHERE date = ? ORDER BY time ASC", (date_input,))
    appointments = cursor.fetchall()

    if appointments:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–ø–∏—Å—è–º–∏
        appointments_text = "\n\n".join([f"ID: {id}\nüë§ –ò–º—è: {name}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: {phone}\nüìÖ –î–∞—Ç–∞: {date}\n‚è∞ –í—Ä–µ–º—è: {time}"
                                        for id, user_id, name, phone, date, time in appointments])
        await message.answer(f"–ó–∞–ø–∏—Å–∏ –Ω–∞ {date_input}:\n{appointments_text}")
    else:
        await message.answer(f"–ù–∞ {date_input} –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.")

    await state.clear()


@router.message(Command("cancel"))
async def cancel_appointment(message: types.Message):
    user_id = message.from_user.id  # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("SELECT id, date, time, name, phone FROM appointments WHERE user_id = ?", (user_id,))
    appointment = cursor.fetchone()

    if appointment:
        # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å
        cursor.execute("DELETE FROM appointments WHERE id = ?", (appointment[0],))
        conn.commit()

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏
        appointment_date = datetime.strptime(appointment[1], "%Y-%m-%d")
        appointment_time = datetime.strptime(appointment[2], "%H:%M").time()

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
        now = datetime.now()
        now_date = now.date()
        now_time = now.time()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–º–µ–Ω–µ–Ω–∞ –ª–∏ –∑–∞–ø–∏—Å—å –∑–∞ –¥–µ–Ω—å –¥–æ –∑–∞–ø–∏—Å–∏ –∏–ª–∏ –≤ –¥–µ–Ω—å –∑–∞–ø–∏—Å–∏
        if (now_date == appointment_date.date() and now_time >= appointment_time) or (now_date + timedelta(days=1) == appointment_date.date()):
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            admin_message = (
                f"üîî –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞!\n"
                f"üë§ –ò–º—è: {appointment[3]}\n"
                f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: {appointment[4]}\n"
                f"üìÖ –î–∞—Ç–∞: {appointment[1]}\n"
                f"‚è∞ –í—Ä–µ–º—è: {appointment[2]}\n"
                f"–û—Ç–º–µ–Ω–µ–Ω–æ: {now.strftime('%Y-%m-%d %H:%M')}"
            )

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
            for admin_id in ADMIN_IDS:
                try:
                    await bot.send_message(admin_id, admin_message)
                except Exception as e:
                    print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–¥–º–∏–Ω—É {admin_id}: {e}")

        await message.answer(f"‚ùå –í–∞—à–∞ –∑–∞–ø–∏—Å—å –Ω–∞ {appointment[1]} –≤ {appointment[2]} –æ—Ç–º–µ–Ω–µ–Ω–∞.")

        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º
        global available_dates, available_times_for_dates, date_keyboard
        available_dates, available_times_for_dates = create_available_keyboards()
        date_keyboard = ReplyKeyboardMarkup(keyboard=[[KeyboardButton(text=date)] for date in available_dates], resize_keyboard=True)

    else:
        await message.answer("‚ö† –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏.")


# –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    dp.include_router(router)

    # –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    asyncio.create_task(send_reminders())

    # –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
    asyncio.create_task(delete_old_appointments())
    await dp.start_polling(bot)


if __name__ == '__main__':
    asyncio.run(main())